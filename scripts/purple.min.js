var gotten=0,players={},weeks=[];function renderComp(t){t||(t=getCurrentWeek());var e=weeks[t],s=[];for(let b of e){var a={},r={},l={qb:"att",wr:"targets",te:"targets",de:"blitz",lb:"blitz",cb:"targets",s:"targets"};for(let e of["qb","wr","te","de","lb","cb","s"]){var o=[],n=[];for(let t of players[e])t.team==b.awayIndex&&o.push(t),t.team==b.homeIndex&&n.push(t);for(let s of o)JSON.parse(s.stats)[l[e]][t]&&(a[e]=s);for(let s of n)JSON.parse(s.stats)[l[e]][t]&&(r[e]=s);a[e]||(a[e]=o[0]),r[e]||(r[e]=o[0])}(o=calc(a,r,t))[0]&&(o[0].off=b.away,o[0].def=b.home,o[1].off=b.home,o[1].def=b.away),s=s.concat(o)}console.log(s),s.sort(function(t,e){return e.z-t.z});for(let t of s){let e=document.getElementsByClassName("table")[0].insertRow(),s=[`${t.off} Offense/${t.def} Defense`,t.v,t.z,t.pv,t.m,t.s,t.t,t.l];for(let t of s){let s=e.insertCell();s.textContent="number"==typeof t?t.toFixed(3):t}}}function calc(t,e,s){exp=[];var a={qb:t.qb,wr:t.wr,te:t.te,de:e.de,lb:e.lb,cb:e.cb,s:e.s},r={qb:e.qb,wr:e.wr,te:e.te,de:t.de,lb:t.lb,cb:t.cb,s:t.s};for(let t of[a,r]){if(!t.qb)continue;for(let e in t)t[e].statA=JSON.parse(t[e].statA),t[e].statB=JSON.parse(t[e].statB),t[e].statC=JSON.parse(t[e].statC),t[e].stats=JSON.parse(t[e].stats);if(null==t.qb.stats.att[s]){let t=new Q(0,0);return[t,t]}let e=q(t.de.statA.m,t.de.statA.s).constMult(t.de.stats.blitz[s]/t.qb.stats.att[s]),a=q(t.lb.statA.m,t.lb.statA.s).constMult(t.lb.stats.blitz[s]/t.qb.stats.att[s]),r=e.add(a),l=q(t.qb.statA.m,t.qb.statA.s).subtract(r),o=q(t.qb.statB.m,t.qb.statB.s).subtract(r),n=new Q(t.wr.statA.m,t.wr.statA.s),b=new Q(t.wr.statB.m,t.wr.statB.s),f=new Q(t.te.statA.m,t.te.statA.s),m=new Q(t.te.statB.m,t.te.statB.s),d=10/(3*t.wr.statC.m),c=10/(3*t.te.statC.m),u=t.wr.stats.targets[s]/t.qb.stats.att[s],w=1-u,p=new Q(t.cb.statA.m,t.cb.statA.s),i=new Q(t.s.statA.m,t.s.statA.s),g=l.mult(n).mult(i).constMult(u*d),v=o.mult(b).mult(i).constMult(u*(1-d)),y=l.mult(f).mult(p).constMult(w*c),A=o.mult(m).mult(p).constMult(w*(1-c)),x=g.add(v),C=y.add(A),h=x.add(C);h.v=t.qb.stats.comp[s]/t.qb.stats.att[s],h.pv=stats.q.cdf(h.v,h),h.pv>.5&&0!=h.pv&&(h.pv=1-h.pv),h.z=(h.v-h.m)/h.t,exp.push(h)}return exp}function q(t,e,s,a,r){return new Q(t,e,s,a,r)}ws.onopen=(()=>{ws.send(JSON.stringify({method:"request",type:"players",qual:"all"}));var t={method:"request",type:"games",qual:"week",crit:getCurrentWeek()};ws.send(JSON.stringify(t))}),ws.onmessage=(t=>{gotten++;const e=JSON.parse(t.data);if(console.log(e),"players"==e.type){var s=["qb","rb","wr","te","de","lb","cb","s","k","p"];for(let t=0,a=s[0];t<10;a=s[++t])players[a]=e.data.slice(50*t,50*(t+1))}else{for(let t of e.data)t.awayIndex=getTeamIndex(t.away),t.homeIndex=getTeamIndex(t.home);weeks[e.crit]=e.data}gotten>=2&&renderComp(e.crit)});